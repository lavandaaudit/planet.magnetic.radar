<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>planet.magnetic.radar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
    margin:0;
    background:#000;
    color:#bfe9ff;
    font-family: Inter, system-ui, monospace;
    overflow:hidden;
}
#hud{
    position:fixed;
    top:10px;
    left:10px;
    z-index:10;
    background:rgba(0,0,0,0.5);
    padding:10px;
    border:1px solid #1b4b66;
    font-size:13px;
}
canvas{display:block}
</style>
</head>

<body>

<div id="hud">
ðŸ§­ INTERMAGNET<br>
ðŸ§® Stability spectrum<br>
ðŸŒ€ Substorms
</div>

<canvas id="c"></canvas>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize(){
    canvas.width = innerWidth;
    canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

/* ---------------- DATA LOADING ---------------- */

function loadData(){
    return Promise.all([
        fetch("data/ae.json").then(r=>r.json()),
        fetch("data/dst.json").then(r=>r.json()),
        fetch("data/stations.json").then(r=>r.json())
    ]);
}

loadData()
.then(([ae, dst, stations])=>{
    console.log("AE", ae);
    console.log("DST", dst);
    console.log("STATIONS", stations);
    startRadar(ae, dst, stations);
})
.catch(e=>console.error("LOAD ERROR", e));

/* ---------------- CORE ---------------- */

function startRadar(ae, dst, stations){

    let t = 0;

    function drawEarth(){
        const r = Math.min(canvas.width, canvas.height)*0.32;
        const cx = canvas.width/2;
        const cy = canvas.height/2;

        ctx.strokeStyle="#1b4b66";
        ctx.lineWidth=2;
        ctx.beginPath();
        ctx.arc(cx,cy,r,0,Math.PI*2);
        ctx.stroke();

        // latitude lines
        for(let i=-60;i<=60;i+=30){
            ctx.beginPath();
            ctx.ellipse(cx,cy+r*Math.sin(i*Math.PI/180),r, r*Math.cos(i*Math.PI/180),0,0,Math.PI*2);
            ctx.stroke();
        }
    }

    function project(lat, lon){
        const r = Math.min(canvas.width, canvas.height)*0.32;
        const cx = canvas.width/2;
        const cy = canvas.height/2;
        return {
            x: cx + r * Math.cos(lat*Math.PI/180) * Math.sin(lon*Math.PI/180),
            y: cy - r * Math.sin(lat*Math.PI/180)
        }
    }

    function drawStations(){
        ctx.fillStyle="#00ffff";
        ctx.font="11px monospace";
        stations.forEach(s=>{
            const p = project(s.lat, s.lon);
            ctx.beginPath();
            ctx.arc(p.x,p.y,2,0,Math.PI*2);
            ctx.fill();
            ctx.fillText(s.code, p.x+4, p.y-4);
        });
    }

    function drawVortices(){
        const cx = canvas.width/2;
        const cy = canvas.height/2;
        ae.slice(-6).forEach((v,i)=>{
            const a = t*0.002 + i;
            const r = 120 + v.value*0.1;
            ctx.strokeStyle="rgba(255,0,150,0.4)";
            ctx.beginPath();
            ctx.arc(cx+Math.cos(a)*r, cy+Math.sin(a)*r, 20+v.value*0.02, 0, Math.PI*2);
            ctx.stroke();
        });
    }

    function stabilitySpectrum(){
        const M = [
            [1, ae.at(-1)?.value||0, 0],
            [0, 1, dst.at(-1)?.value||0],
            [0, 0, 1]
        ];

        const trace = M[0][0]+M[1][1]+M[2][2];
        const energy = Math.sqrt(M[0][1]*M[0][1]+M[1][2]*M[1][2]);

        ctx.fillStyle="#9ff";
        ctx.fillText("trace: "+trace.toFixed(2), 10, canvas.height-40);
        ctx.fillText("energy: "+energy.toFixed(2), 10, canvas.height-25);
    }

    function loop(){
        t++;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        drawEarth();
        drawStations();
        drawVortices();
        stabilitySpectrum();
        requestAnimationFrame(loop);
    }
    loop();
}
</script>

</body>
</html>
