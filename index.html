<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>MAGNETOSPHERE · STABILITY RADAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{
  margin:0;
  background:#000;
  color:#8fd3ff;
  font-family:Inter,system-ui,monospace;
}
canvas{display:block}
#panel{
  position:fixed;
  left:10px; top:10px;
  background:rgba(0,0,0,.6);
  padding:12px;
  border:1px solid #1c3f55;
}
.alert{
  color:#ff5c5c;
  font-weight:bold;
}
</style>
</head>
<body>

<canvas id="c"></canvas>

<div id="panel">
  <div>Dst: <span id="dst">–</span></div>
  <div>AE: <span id="ae">–</span></div>
  <div>Kp: <span id="kp">–</span></div>
  <div id="state">state: loading</div>
</div>

<script>
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
resize();
window.onresize = resize;

let data = {};

async function loadJSON(){
  const files = ["dst","ae","kp","stations"];
  for(const f of files){
    data[f] = await fetch(`data/${f}.json`).then(r=>r.json());
  }
}
function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}

function drawEarth(){
  const r = Math.min(canvas.width,canvas.height)*0.25;
  ctx.strokeStyle="#1f6b8a";
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.arc(canvas.width/2,canvas.height/2,r,0,Math.PI*2);
  ctx.stroke();
}

function drawStations(){
  const r = Math.min(canvas.width,canvas.height)*0.25;
  data.stations.forEach(s=>{
    const x = canvas.width/2 + r*Math.cos(s.lon*Math.PI/180);
    const y = canvas.height/2 - r*Math.sin(s.lat*Math.PI/180);
    ctx.fillStyle="#4fc3ff";
    ctx.beginPath();
    ctx.arc(x,y,2,0,Math.PI*2);
    ctx.fill();
  });
}

let t=0;
function drawSubstorms(level){
  const cx=canvas.width/2, cy=canvas.height/2;
  for(let i=0;i<6;i++){
    ctx.strokeStyle=`rgba(255,80,80,${level})`;
    ctx.beginPath();
    for(let a=0;a<Math.PI*2;a+=0.2){
      const r=120+20*Math.sin(a*3+t+i);
      ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));
    }
    ctx.stroke();
  }
}

function stabilityMatrix(dst,ae,kp){
  return [
    [1, kp/9, ae/2000],
    [kp/9, 1, dst/-300],
    [ae/2000, dst/-300, 1]
  ];
}

function spectrum(m){
  return m.flat().reduce((a,b)=>a+Math.abs(b),0)/9;
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawEarth();
  drawStations();

  const dst = data.dst.value;
  const ae  = data.ae.value;
  const kp  = data.kp.value;

  document.getElementById("dst").textContent = dst;
  document.getElementById("ae").textContent  = ae;
  document.getElementById("kp").textContent  = kp;

  const M = stabilityMatrix(dst,ae,kp);
  const S = spectrum(M);

  drawSubstorms(Math.min(1,S/2));

  const state = document.getElementById("state");
  if(S>1.2){
    state.innerHTML = "<span class='alert'>UNSTABLE</span>";
  } else {
    state.textContent = "stable";
  }

  t+=0.01;
  requestAnimationFrame(render);
}

loadJSON().then(render);
</script>
</body>
</html>
